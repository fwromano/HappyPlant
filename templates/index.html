<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plant Watering Calculator</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <h1>üå± Plant Watering Calculator</h1>
      <p style="text-align: center">
        Get personalized watering recommendations for your plants
      </p>

      <div class="feature-nav-tabs">
        <a href="/test/identify" class="feature-tab-link">Plant Identifier</a>
        <a href="/test/pot-size" class="feature-tab-link">Pot Size Estimator</a>
        <a href="/test/schedule" class="feature-tab-link"
          >Schedule Calculator</a
        >
      </div>
      <div class="calculator-section">
        <div class="tabs">
          <button class="tab active" onclick="switchTab('photo')">
            üì∏ Upload Photo
          </button>
          <button class="tab" onclick="switchTab('manual')">
            ‚úèÔ∏è Manual Entry
          </button>
        </div>

        <div id="photoTab" class="tab-content active">
          <div class="upload-section">
            <label for="fileInput" class="upload-btn">Upload Plant Photo</label>
            <input
              type="file"
              id="fileInput"
              accept="image/*"
              style="display: none"
            />
          </div>
          <div class="image-preview" id="imagePreview"></div>
        </div>
        <div id="manualTab" class="tab-content">
          <div class="manual-section">
            <form id="manualForm">
              <div class="form-group">
                <label for="manualPlantNameInput">Plant Name:</label>
                <input
                  type="text"
                  id="manualPlantNameInput"
                  class="form-control"
                  placeholder="e.g., Snake Plant, Pothos, Peace Lily"
                  required
                />
              </div>
              <div class="form-group">
                <label for="manualPotVolumeInput">Pot Volume (liters):</label>
                <input
                  type="number"
                  id="manualPotVolumeInput"
                  class="form-control"
                  min="0.1"
                  step="0.1"
                  placeholder="e.g., 2.5"
                  required
                />
              </div>
              <button
                type="button"
                class="calculate-btn"
                onclick="calculateManual()"
              >
                Calculate Watering Schedule
              </button>
            </form>
          </div>
        </div>
        <div class="loading" id="loading">
          <p>Analyzing... üîç</p>
        </div>
        <div class="error" id="error"></div>
        <div class="results profile-card" id="results">
          <div class="profile-card-content">
            
            <div class="profile-section">
              <h3><i class="icon icon-plant"></i>Plant Information</h3>
              <p><strong>Name:</strong> <span id="resultPlantName">N/A</span></p>
              <p><strong>Scientific Name:</strong> <span id="resultScientificName">N/A</span></p>
              <p><strong>Family:</strong> <span id="resultPlantFamily">N/A</span></p>
              <p><strong>ID Confidence:</strong> <span id="resultConfidence">N/A</span>%</p>
            </div>
  
            <div class="profile-section">
              <h3><i class="icon icon-pot"></i>Pot Information</h3>
              <p><strong>Est. Diameter:</strong> <span id="resultPotDiameter">N/A</span> cm</p>
              <p><strong>Est. Volume:</strong> <span id="resultPotVolume">N/A</span> L</p>
              <p><strong>Est. Confidence:</strong> <span id="resultPotConfidence">N/A</span></p>
            </div>
            
          </div> <div class="profile-card-footer watering-schedule">
            <h3><i class="icon icon-water"></i>Watering Schedule</h3>
            <p id="resultWateringScheduleSummary">N/A</p>
            <div class="schedule-details">
                <p><strong>Amount:</strong> <span id="resultWaterAmount">N/A</span> ml</p>
                <p><strong>Frequency:</strong> Every <span id="resultFrequency">N/A</span> days</p>
                <p><strong>Moisture Need:</strong> <span id="resultMoistureLevel">N/A</span></p>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>
    <script>
      // --- Tab Switching Logic ---
      function switchTab(tabId) {
        document
          .querySelectorAll(".tabs .tab")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".calculator-section .tab-content")
          .forEach((content) => content.classList.remove("active"));

        document
          .querySelector(`.tabs [onclick="switchTab('${tabId}')"]`)
          .classList.add("active");
        document.getElementById(`${tabId}Tab`).classList.add("active");

        clearFeedbackAndResults();
        document.getElementById("imagePreview").innerHTML = "";
        const fileInput = document.getElementById("fileInput");
        if (fileInput) fileInput.value = null;
        const manualName = document.getElementById("manualPlantNameInput");
        const manualVol = document.getElementById("manualPotVolumeInput");
        if (manualName) manualName.value = "";
        if (manualVol) manualVol.value = "";
      }

      // --- Clear Feedback and Results ---
      function clearFeedbackAndResults() {
        const resultsDiv = document.getElementById("results");
        const errorDiv = document.getElementById("error");
        const loadingDiv = document.getElementById("loading");

        if (resultsDiv) resultsDiv.style.display = "none";
        if (errorDiv) {
          errorDiv.style.display = "none";
          errorDiv.textContent = "";
        }
        if (loadingDiv) loadingDiv.style.display = "none";

        // Reset result fields to 'N/A'
        const idsToReset = [
          "resultPlantName",
          "resultScientificName",
          "resultPlantFamily",
          "resultConfidence",
          "resultPotDiameter",
          "resultPotVolume",
          "resultPotConfidence",
          "resultWateringScheduleSummary",
          "resultWaterAmount",
          "resultFrequency",
          "resultMoistureLevel",
        ];
        idsToReset.forEach((id) => {
          const element = document.getElementById(id);
          if (element) element.textContent = "N/A";
        });
      }

      // --- Show Loading Indicator ---
      function showLoading(message = "Processing...") {
        clearFeedbackAndResults();
        const loadingDiv = document.getElementById("loading");
        if (loadingDiv) {
          loadingDiv.querySelector("p").textContent = message;
          loadingDiv.style.display = "block";
        }
      }

      // --- Show Error Message ---
      function showError(message) {
        clearFeedbackAndResults();
        const errorDiv = document.getElementById("error");
        if (errorDiv) {
          errorDiv.textContent = message;
          errorDiv.style.display = "block";
        }
        const loadingDiv = document.getElementById("loading");
        if (loadingDiv) loadingDiv.style.display = "none";
      }

      // --- Event Listener for File Input ---
      const fileInputElement = document.getElementById("fileInput");
      if (fileInputElement) {
        fileInputElement.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              const preview = document.getElementById("imagePreview");
              if (preview) {
                preview.innerHTML = `<img src="${event.target.result}" alt="Plant preview" style="max-width: 100%; max-height: 350px; border-radius: 5px; margin-top: 10px;">`;
              }
            };
            reader.readAsDataURL(file);
            uploadFile(file);
          } else {
            const preview = document.getElementById("imagePreview");
            if (preview) preview.innerHTML = "";
          }
        });
      }

      // --- File Upload Function ---
      function uploadFile(file) {
        const formData = new FormData();
        formData.append("file", file);
        showLoading("Analyzing your plant... üîç");

        fetch("/upload", { method: "POST", body: formData })
          .then(async (response) => {
            const data = await response.json();
            if (!response.ok)
              throw new Error(data.error || `Server error: ${response.status}`);
            return data;
          })
          .then((data) => {
            const loadingDiv = document.getElementById("loading");
            if (loadingDiv) loadingDiv.style.display = "none";
            showResults(data);
          })
          .catch((error) => {
            console.error("Upload Error:", error);
            showError(`Processing failed: ${error.message}`);
          });
      }

      // --- Manual Calculation Function ---
      function calculateManual() {
        const plantNameInput = document.getElementById("manualPlantNameInput");
        const potVolumeInput = document.getElementById("manualPotVolumeInput");
        const plantName = plantNameInput.value.trim();
        const potVolume = potVolumeInput.value;

        if (!plantNameInput.checkValidity()) {
          plantNameInput.reportValidity();
          return;
        }
        if (!potVolumeInput.checkValidity() || parseFloat(potVolume) <= 0) {
          potVolumeInput.setCustomValidity(
            "Please enter a positive number for volume."
          );
          potVolumeInput.reportValidity();
          return;
        }
        potVolumeInput.setCustomValidity("");

        showLoading("Calculating schedule... üíß");

        fetch("/manual-calculate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            plant_name: plantName,
            pot_volume: parseFloat(potVolume),
          }),
        })
          .then(async (response) => {
            const data = await response.json();
            if (!response.ok)
              throw new Error(data.error || `Server error: ${response.status}`);
            return data;
          })
          .then((data) => {
            const loadingDiv = document.getElementById("loading");
            if (loadingDiv) loadingDiv.style.display = "none";
            showResults(data);
          })
          .catch((error) => {
            console.error("Manual Calculation Error:", error);
            showError(`Calculation failed: ${error.message}`);
          });
      }

      // --- Display Results Function (with Logging) ---
      function showResults(data) {
        // Log the received data structure to the console for debugging
        console.log(
          "Received data for showResults:",
          JSON.stringify(data, null, 2)
        );

        clearFeedbackAndResults(); // Clear N/A values before populating

        const plantInfo = data.plant_info || {};
        const potInfo = data.pot_info || {};
        const schedule = data.watering_schedule || {};

        // Helper function to safely set text content
        const setText = (id, text) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = text ?? "N/A"; // Use N/A if text is null/undefined
          } else {
            console.warn(`Element with ID "${id}" not found.`);
          }
        };

        // Populate Plant Information
        setText("resultPlantName", plantInfo.common_name);
        setText("resultScientificName", plantInfo.scientific_name);
        setText("resultPlantFamily", plantInfo.family);
        const confidence = plantInfo.confidence;
        setText(
          "resultConfidence",
          typeof confidence === "number" ? (confidence * 100).toFixed(1) : "N/A"
        );

        // Populate Pot Information
        const diameter = potInfo.diameter_cm;
        const volume = potInfo.estimated_volume_liters;
        setText(
          "resultPotDiameter",
          typeof diameter === "number" ? diameter.toFixed(1) : "N/A"
        );
        setText(
          "resultPotVolume",
          typeof volume === "number" ? volume.toFixed(2) : "N/A"
        );
        setText("resultPotConfidence", potInfo.confidence);

        // Populate Watering Schedule
        setText(
          "resultWateringScheduleSummary",
          schedule.schedule_summary || schedule.schedule
        );
        setText("resultWaterAmount", schedule.water_amount_ml);
        setText("resultFrequency", schedule.frequency_days);
        setText(
          "resultMoistureLevel",
          schedule.moisture_level_required || schedule.moisture_level
        );

        // Show the results block
        const resultsDiv = document.getElementById("results");
        if (resultsDiv) resultsDiv.style.display = "block";
      }

      // --- Initialize ---
      document.addEventListener("DOMContentLoaded", () => {
        switchTab("photo");
        clearFeedbackAndResults();
      });
    </script>
  </body>
</html>
